<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gilnean Royal Library</title>
    <style>
      :root{
        --navy:#2b2f5e; --navy-2:#2e3264; --gold:#d59a2b; --paper:#ffffff;
      }
      html,body{height:100%;}
      body{margin:0;background:var(--navy);color:#f7f1e8;font-family:"Garamond","Georgia",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
      .topbar{display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px dashed rgba(255,255,255,.15)}
      .topbar .seal{
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        display: inline-block;
        box-shadow: 0 0 0 2px rgba(255,255,255,0.15) inset;
      }
      @media (max-width: 480px){
        .topbar .seal{ width: 60px; height: 60px; }
      }
      .topbar .ministry{opacity:.9;font-size:26px;letter-spacing:.3px}
      .wrap{max-width:1100px;margin:0 auto;padding:0 24px 48px}
      .title{text-align:center;margin:28px 0 10px;font-size:54px;letter-spacing:2px;color:var(--gold);font-weight:600;text-transform:uppercase}
      .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);margin:18px 0 26px}
      .section-title{text-align:center;color:var(--gold);font-size:24px;letter-spacing:1px;text-transform:uppercase;margin:10px 0 14px}

      /* Search bar */
      .search-wrap{display:flex;justify-content:center;margin:8px 0 18px}
      .search{
        width:min(680px,100%);display:flex;gap:10px;
        background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);
        border-radius:10px;padding:10px 12px
      }
      .search input{
        flex:1;background:transparent;border:0;outline:none;color:#fff;
        font-size:16px;letter-spacing:.2px
      }
      .search button{
        background:var(--gold);border:0;border-radius:8px;color:#2b2f5e;
        padding:8px 12px;font-weight:600;cursor:pointer
      }
      .search input::placeholder{color:#cfd3e6}
      .search input:disabled{opacity:.6}
      .search .clear{background:transparent;border:1px solid rgba(255,255,255,.35);color:#fff}

      /* Filters (Category/Sub-category) */
      .filters{
        display:flex; gap:16px; align-items:flex-start; justify-content:center;
        margin:8px 0 10px;
      }
      .filter{ display:flex; flex-direction:column; min-width:220px; }
      .filter label{
        font-size:14px; color:#cfd3e6; margin:0 0 6px 2px; letter-spacing:.3px;
      }
      select[multiple]{
        background:rgba(255,255,255,.06);
        border:1px solid rgba(255,255,255,.18);
        color:#f7f1e8; border-radius:10px; padding:8px; min-height:140px;
      }
      select[multiple]:disabled{ opacity:.6; cursor:not-allowed; }
      #clearFilters{ align-self:flex-end; height:36px; margin-top:22px; }
      @media (max-width: 820px){
        .filters{ flex-direction:column; align-items:center; }
        .filter{ width:min(680px,100%); }
        #clearFilters{ align-self:center; }
      }

      /* Genre buttons */
      .genre-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:26px;margin:18px 0 12px}
      .genre-btn{
        background:var(--paper);color:var(--navy-2);border:0;border-radius:8px;padding:14px 18px;font-size:18px;
        cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.25);
        transition:transform .08s ease,box-shadow .2s ease,background .2s ease;
        font-family:"Garamond","Georgia",serif;
      }
      .genre-btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.35)}
      .genre-btn.active{outline:2px solid var(--gold);background:#fffdf7}

      /* Sub-list */
      .sublist{margin-top:24px;background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.18);border-radius:10px;padding:16px 18px}
      .sublist h3{margin:0 0 10px;font-weight:600;color:#f1e5cf;letter-spacing:.5px}
      .items{list-style:none;padding:0;margin:0}
      .items li{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.09)}
      .items li:last-child{border-bottom:0}
      .items a{color:var(--gold);text-decoration:none;font-size:18px}
      .items a:hover{text-decoration:underline}
      .empty{color:#cbd0ea;font-style:italic;padding:6px 2px}
      .footer{margin-top:10px;color:#c8cdeb;font-size:13px}
      .err{margin-top:12px;color:#ffb3b3;white-space:pre-wrap;font-size:13px}

      /* Meta line (author/date) */
      .meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 2px;
        color: #c8cdeb;
        font-size: 14px;
        line-height: 1.4;
        width: 100%;
      }
      .meta .left, .meta .right { display:inline-block; }
      .meta .left  { text-align:left; }
      .meta .right { text-align:right; margin-left:auto; }
      @media (max-width: 600px) {
        .meta { flex-direction: column; align-items: flex-start; gap: 2px; }
        .meta .right { margin-left: 0; text-align: left; }
      }

      /* Loader */
      #loader {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at center, #2e3264 0%, #1a1c35 100%);
        display: flex; align-items: center; justify-content: center; flex-direction: column;
        z-index: 999; color: #f7f1e8; font-family: "Garamond","Georgia",serif; text-align: center; letter-spacing: 1px;
        transition: opacity 0.8s ease, visibility 0.8s ease;
      }
      #sparkles { font-size: 18px; white-space: pre; animation: sparklePulse 1.5s ease-in-out infinite; line-height: 1.6em; }
      @keyframes sparklePulse { 0%{opacity:.4;transform:scale(1)}50%{opacity:1;transform:scale(1.05)}100%{opacity:.4;transform:scale(1)} }
      #loader.fade { opacity:0; visibility:hidden; }

      /* --- Custom multi-select dropdown --- */
      .msel{ position:relative; min-width:220px; }
      .msel .control{
        width:100%;
        background:rgba(255,255,255,.06);
        border:1px solid rgba(255,255,255,.18);
        color:#f7f1e8; border-radius:10px;
        padding:10px 12px; text-align:left; cursor:pointer;
        font: inherit;
      }
      .msel.disabled .control{ opacity:.6; cursor:not-allowed; }
      .msel .menu{
        position:absolute; top:100%; left:0; right:0;
        background:#2e3264; border:1px solid rgba(255,255,255,.18);
        border-radius:10px; margin-top:6px; max-height:220px;
        overflow:auto; display:none; z-index:100;
        box-shadow:0 10px 24px rgba(0,0,0,.35);
      }
      .msel.open .menu{ display:block; }
      .msel .row{ display:flex; align-items:center; gap:8px; padding:8px 10px; }
      .msel .row:hover{ background:rgba(255,255,255,.06); }
      .msel input[type="checkbox"]{ accent-color:var(--gold); }
      .msel .placeholder{ opacity:.8; }

      
    </style>
  </head>
  <body>
    <div id="loader">
      <pre id="sparkles">
     ✨ ✶  ⋆  ✨
   ⊹  The Library awakens...  ⊹
    ✨ ⋆ ✨ ✶ ✨
      </pre>
    </div>

    <div class="topbar">
      <img class="seal" src="assets/seal.png" alt="Ministry of the Home Office Seal" loading="lazy" />
      <div class="ministry">Ministry of the Home Office</div>
    </div>

    <div class="wrap">
      <div class="title">Gilnean Royal Library</div>
      <div class="divider"></div>

      <div class="section-title">Genre Selection</div>

      <!-- Search (disabled until a genre is chosen) -->
      <div class="search-wrap">
        <div class="search">
          <input id="q" type="text" placeholder="Filter current genre…" disabled>
          <button id="clear" class="clear" disabled>Clear</button>
          <button id="searchBtn" disabled>Search</button>
        </div>
      </div>

      <!-- Filters: Category & Subcategory (disabled until a genre is chosen) -->
      <div class="filters">
        <div class="filter">
          <label for="catSel">Category</label>
          <select id="catSel" multiple size="6" disabled></select>
        </div>
        <div class="filter">
          <label for="subSel">Sub-category</label>
          <select id="subSel" multiple size="6" disabled></select>
        </div>
        <button id="clearFilters" class="clear" disabled>Clear Filters</button>
      </div>


      <div id="genres" class="genre-row"></div>

      <div id="panel" class="sublist" style="display:none;">
        <h3 id="panelTitle">Selected Genre</h3>
        <ul id="items" class="items"></ul>
        <div id="footer" class="footer"></div>
        <div id="err" class="err"></div>
      </div>
    </div>

    <script>
      // ===== Data source =====
      const API = 'https://script.google.com/macros/s/AKfycbyrsTDK1h5DJfyZkzL1Wocp3Axy8TfBEbLCkB-4FTxG3wN9Dhv2_EZ2Xau7gBk1TsDT/exec';

      // State
      let rows = [];            // raw rows
      let byGenre = new Map();  // genre -> items for that genre
      let activeGenre = null;
      let currentItems = [];    // items for active genre (unfiltered)

      // Elements
      const genresEl  = document.getElementById('genres');
      const panelEl   = document.getElementById('panel');
      const titleEl   = document.getElementById('panelTitle');
      const listEl    = document.getElementById('items');
      const footerEl  = document.getElementById('footer');
      const errEl     = document.getElementById('err');
      const qEl       = document.getElementById('q');
      const clearEl   = document.getElementById('clear');
      const searchBtn = document.getElementById('searchBtn');
      const catSel    = document.getElementById('catSel');
      const subSel    = document.getElementById('subSel');
      const clearFiltersBtn = document.getElementById('clearFilters');
      const catMS = makeMultiselect(document.getElementById('catMS'));
      const subMS = makeMultiselect(document.getElementById('subMS'));
      const clearFiltersBtn = document.getElementById('clearFilters');

      // Start disabled
      catSel.disabled = subSel.disabled = clearFiltersBtn.disabled = true;

      // ---------- Init / Load ----------
      function finishInit(data){
        document.getElementById('loader').classList.add('fade');

        rows = Array.isArray(data) ? data : [];
        byGenre = new Map();

        for (const r of rows){
          const g = (r?.genre || '').toString().trim();
          const t = (r?.text  || '').toString().trim();
          if (!g || !t) continue;
          if (!byGenre.has(g)) byGenre.set(g, []);
          byGenre.get(g).push({
            text: t,
            url: r?.url || null,
            author: (r?.author || '').toString(),
            date: (r?.date || '').toString(),
            category: (r?.category || '').toString(),
            subcategory: (r?.subcategory || '').toString()
          });
        }

        renderGenres();
        wireSearch();

        // Filter events
        catSel.addEventListener('change', applyFilter);
        subSel.addEventListener('change', applyFilter);
        // Filter events
        clearFiltersBtn.addEventListener('click', e=>{
          e.preventDefault();
          catMS.clear(); subMS.clear();
          applyFilter();
        });

      }

      function makeMultiselect(root){
        const label = root.dataset.label || 'Options';
        const state = { selected:new Set(), disabled:true };
      
        const control = document.createElement('button');
        control.type = 'button';
        control.className = 'control';
        control.textContent = `All ${label.toLowerCase()}s`;
        const menu = document.createElement('div'); menu.className = 'menu';
        root.append(control, menu);
      
        function displayText(){
          const n = state.selected.size;
          return n ? `${n} selected` : `All ${label.toLowerCase()}s`;
        }
        function setOptions(values){
          menu.innerHTML = '';
          state.selected.clear();
          values.slice().sort((a,b)=>a.localeCompare(b)).forEach(v=>{
            const row = document.createElement('label'); row.className = 'row';
            const cb  = document.createElement('input'); cb.type='checkbox'; cb.value=v;
            const sp  = document.createElement('span');  sp.textContent=v;
            row.append(cb, sp); menu.appendChild(row);
            cb.addEventListener('change', ()=>{
              cb.checked ? state.selected.add(v) : state.selected.delete(v);
              control.textContent = displayText();
              applyFilter();
            });
          });
          control.textContent = displayText();
        }
        function setDisabled(d){
          state.disabled = d;
          root.classList.toggle('disabled', d);
          control.disabled = d;
          if (d) root.classList.remove('open');
        }
        function clear(){
          state.selected.clear();
          menu.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked=false);
          control.textContent = displayText();
        }
        control.addEventListener('click', ()=>{
          if (state.disabled) return;
          root.classList.toggle('open');
        });
        // click outside to close
        document.addEventListener('click', (e)=>{
          if (!root.contains(e.target)) root.classList.remove('open');
        });
      
        return {
          setOptions, setDisabled, clear,
          getSelected: () => new Set(state.selected)
        };
      }
      
      function unique(arr){ return [...new Set(arr)]; }


      function showErr(msg){
        document.getElementById('loader').classList.add('fade');
        panelEl.style.display = 'block';
        titleEl.textContent = 'Error';
        listEl.innerHTML = '';
        footerEl.textContent = '';
        errEl.textContent = msg;
        console.error(msg);
      }

      function loadViaJSONP(){
        const cb = 'initFromAPI_' + Math.random().toString(36).slice(2);
        window[cb] = function(payload){
          try { finishInit(payload && payload.data); }
          catch(e){ showErr('JSONP parse error: ' + (e?.message||e)); }
          finally{ delete window[cb]; if (script && script.parentNode) script.parentNode.removeChild(script); }
        };
        const url = API + (API.includes('?') ? '&' : '?') + 'callback=' + encodeURIComponent(cb);
        const script = document.createElement('script');
        script.src = url;
        script.onerror = () => showErr('JSONP load failed. Check your /exec URL.');
        document.head.appendChild(script);
      }

      window.addEventListener('load', () => {
        setTimeout(() => {
          const loader = document.getElementById('loader');
          if (loader && !loader.classList.contains('fade')) {
            showErr('Loading is taking longer than expected. Please check the API URL or try again.');
          }
        }, 8000);

        fetch(API, { mode: 'cors' })
          .then(r => { if (!r.ok) throw new Error('Network error: ' + r.status); return r.json(); })
          .then(({ data }) => finishInit(data))
          .catch(err => { console.warn('Fetch failed, using JSONP:', err); loadViaJSONP(); });
      });

      // ---------- Rendering ----------
      function renderGenres(){
        genresEl.innerHTML = '';
        const genres = Array.from(byGenre.keys()).sort((a,b)=>a.localeCompare(b));
        if (!genres.length){
          genresEl.innerHTML = `<div class="empty">No genres found.</div>`;
          return;
        }
        genres.forEach(g => {
          const btn = document.createElement('button');
          btn.className = 'genre-btn';
          btn.textContent = g;
          btn.onclick = () => selectGenre(g, btn);
          genresEl.appendChild(btn);
        });
      }

      function selectGenre(genre, btn){
  activeGenre = genre;
  document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');

  // enable search UI
  qEl.disabled = clearEl.disabled = searchBtn.disabled = false;

  // items for this genre
  currentItems = (byGenre.get(genre) || []).slice();
  titleEl.textContent = genre;
  panelEl.style.display = 'block';
  qEl.value = '';

  // enable & populate dropdowns
  catMS.setDisabled(false);
  subMS.setDisabled(false);
  const cats = unique(currentItems.map(it => it.category).filter(Boolean));
  const subs = unique(currentItems.map(it => it.subcategory).filter(Boolean));
  catMS.setOptions(cats);
  subMS.setOptions(subs);

  clearFiltersBtn.disabled = false;

  renderList(currentItems);
}


      function renderList(items){
        errEl.textContent = '';
        listEl.innerHTML = '';
        if (!items.length){
          listEl.innerHTML = `<li class="empty">No entries for this genre.</li>`;
          footerEl.textContent = '0 items';
          return;
        }
        for (const it of items){
          const li = document.createElement('li');

          if (it.url){
            const a = document.createElement('a');
            a.href = it.url; a.target = '_blank'; a.rel = 'noopener noreferrer';
            a.textContent = it.text;
            li.appendChild(a);
          } else {
            const title = document.createElement('div');
            title.textContent = it.text;
            title.style.fontSize = '18px';
            li.appendChild(title);
          }

          const meta = document.createElement('div');
          meta.className = 'meta';
          const left = document.createElement('span');
          left.className = 'left';
          left.textContent = it.author ? `Authored by: ${it.author}` : 'Authored by: —';
          const right = document.createElement('span');
          right.className = 'right';
          right.textContent = it.date ? `Publishing Date: ${it.date}` : 'Publishing Date: —';
          meta.appendChild(left);
          meta.appendChild(right);
          li.appendChild(meta);

          listEl.appendChild(li);
        }
        footerEl.textContent = `${items.length} item${items.length===1?'':'s'}`;
      }

      // ---------- Filtering ----------
      function wireSearch(){
        const debounced = debounce(applyFilter, 150);
        qEl.addEventListener('input', debounced);
        searchBtn.addEventListener('click', e => { e.preventDefault(); applyFilter(); });
        clearEl.addEventListener('click', e => { e.preventDefault(); qEl.value=''; applyFilter(); });
        qEl.addEventListener('keydown', e => { if (e.key === 'Escape'){ qEl.value=''; applyFilter(); } });
      }

      function applyFilter(){
        if (!activeGenre) return;
      
        const q = qEl.value.trim().toLowerCase();
      
        const selCats = catMS.getSelected();
        const selSubs = subMS.getSelected();
        const hasCat  = selCats.size > 0;
        const hasSub  = selSubs.size > 0;
      
        const filtered = currentItems.filter(it => {
          // text search (title + author)
          const hay = ((it.text||'') + ' ' + (it.author||'')).toLowerCase();
          if (q && !hay.includes(q)) return false;
      
          if (hasCat && !selCats.has(it.category || '')) return false;
          if (hasSub && !selSubs.has(it.subcategory || '')) return false;
      
          return true;
        });
      
        renderList(filtered);
      }


      // ---------- Helpers ----------
      function unique(arr){ return [...new Set(arr)]; }
      function populateMultiSelect(selectEl, values){
        selectEl.innerHTML = '';
        values.sort((a,b)=>a.localeCompare(b)).forEach(v=>{
          const opt = document.createElement('option');
          opt.value = v; opt.textContent = v;
          selectEl.appendChild(opt);
        });
      }
      function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
    </script>
  </body>
</html>
