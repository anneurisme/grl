<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Gilnean Royal Library</title>
    <style>
      :root{
        --navy:#2b2f5e; --navy-2:#2e3264; --gold:#d59a2b; --paper:#ffffff;
      }
      html,body{height:100%;}
      body{margin:0;background:var(--navy);color:#f7f1e8;font-family:"Garamond","Georgia",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
      .topbar{display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px dashed rgba(255,255,255,.15)}
      .topbar .seal{width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,.15)}
      .topbar .ministry{opacity:.9;font-size:16px;letter-spacing:.3px}
      .wrap{max-width:1100px;margin:0 auto;padding:0 24px 48px}
      .title{text-align:center;margin:28px 0 10px;font-size:54px;letter-spacing:2px;color:var(--gold);font-weight:600;text-transform:uppercase}
      .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);margin:18px 0 26px}
      .section-title{text-align:center;color:var(--gold);font-size:24px;letter-spacing:1px;text-transform:uppercase;margin:10px 0 14px}

      /* Search bar */
      .search-wrap{display:flex;justify-content:center;margin:8px 0 18px}
      .search{
        width:min(680px,100%);display:flex;gap:10px;
        background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.18);
        border-radius:10px;padding:10px 12px
      }
      .search input{
        flex:1;background:transparent;border:0;outline:none;color:#fff;
        font-size:16px;letter-spacing:.2px
      }
      .search button{
        background:var(--gold);border:0;border-radius:8px;color:#2b2f5e;
        padding:8px 12px;font-weight:600;cursor:pointer
      }
      .search input::placeholder{color:#cfd3e6}
      .search input:disabled{opacity:.6}
      .search .clear{background:transparent;border:1px solid rgba(255,255,255,.35);color:#fff}

      /* Genre buttons */
      .genre-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:26px;margin:18px 0 12px}
      .genre-btn{
        background:var(--paper);color:var(--navy-2);border:0;border-radius:8px;padding:14px 18px;font-size:18px;
        cursor:pointer;box-shadow:0 4px 14px rgba(0,0,0,.25);
        transition:transform .08s ease,box-shadow .2s ease,background .2s ease;
        font-family:"Garamond","Georgia",serif;
      }
      .genre-btn:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(0,0,0,.35)}
      .genre-btn.active{outline:2px solid var(--gold);background:#fffdf7}

      /* Sub-list */
      .sublist{margin-top:24px;background:rgba(255,255,255,.03);border:1px dashed rgba(255,255,255,.18);border-radius:10px;padding:16px 18px}
      .sublist h3{margin:0 0 10px;font-weight:600;color:#f1e5cf;letter-spacing:.5px}
      .items{list-style:none;padding:0;margin:0}
      .items li{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,.09)}
      .items li:last-child{border-bottom:0}
      .items a{color:var(--gold);text-decoration:none;font-size:18px}
      .items a:hover{text-decoration:underline}
      .empty{color:#cbd0ea;font-style:italic;padding:6px 2px}
      .footer{margin-top:10px;color:#c8cdeb;font-size:13px}
      .err{margin-top:12px;color:#ffb3b3;white-space:pre-wrap;font-size:13px}

      /* --- Whimsical Loader --- */
      #loader {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at center, #2e3264 0%, #1a1c35 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        z-index: 999;
        color: #f7f1e8;
        font-family: "Garamond","Georgia",serif;
        text-align: center;
        letter-spacing: 1px;
        transition: opacity 0.8s ease, visibility 0.8s ease;
      }
      #sparkles {
        font-size: 18px;
        white-space: pre;
        animation: sparklePulse 1.5s ease-in-out infinite;
        line-height: 1.6em;
      }
      @keyframes sparklePulse {
        0% { opacity: 0.4; transform: scale(1);}
        50%{ opacity: 1; transform: scale(1.05);}
        100%{ opacity: 0.4; transform: scale(1);}
      }
      #loader.fade {
        opacity: 0;
        visibility: hidden;
      }
    </style>
  </head>
  <body>
    <div id="loader">
      <pre id="sparkles">
     ✨ ✶  ⋆  ✨
   ⊹  The Library awakens...  ⊹
    ✨ ⋆ ✨ ✶ ✨
      </pre>
    </div>

    <div class="topbar">
      <div class="seal"></div>
      <div class="ministry">Ministry of the Home Office</div>
    </div>

    <div class="wrap">
      <div class="title">Gilnean Royal Library</div>
      <div class="divider"></div>

      <div class="section-title">Genre Selection</div>

      <!-- Genre-scoped search bar (disabled until a genre is selected) -->
      <div class="search-wrap">
        <div class="search">
          <input id="q" type="text" placeholder="Filter current genre…" disabled>
          <button id="clear" class="clear" disabled>Clear</button>
          <button id="searchBtn" disabled>Search</button>
        </div>
      </div>

      <div id="genres" class="genre-row"></div>

      <div id="panel" class="sublist" style="display:none;">
        <h3 id="panelTitle">Selected Genre</h3>
        <ul id="items" class="items"></ul>
        <div id="footer" class="footer"></div>
        <div id="err" class="err"></div>
      </div>
    </div>

<script>
  // ====== ONLY change: where data comes from (works on GitHub Pages) ======
  const API = 'https://script.google.com/macros/s/AKfycbyrsTDK1h5DJfyZkzL1Wocp3Axy8TfBEbLCkB-4FTxG3wN9Dhv2_EZ2Xau7gBk1TsDT/exec'; // ← paste your Apps Script /exec URL exactly

  // State (unchanged)
  let rows = [];            // [{text, url, genre}]
  let byGenre = new Map();  // genre -> [{text,url}]
  let activeGenre = null;
  let currentItems = [];

  // Elements (unchanged)
  const genresEl = document.getElementById('genres');
  const panelEl  = document.getElementById('panel');
  const titleEl  = document.getElementById('panelTitle');
  const listEl   = document.getElementById('items');
  const footerEl = document.getElementById('footer');
  const errEl    = document.getElementById('err');
  const qEl      = document.getElementById('q');
  const clearEl  = document.getElementById('clear');
  const searchBtn= document.getElementById('searchBtn');

  // --- Helper to finish init (same as your old init(), but split so we can call from fetch or JSONP) ---
  function finishInit(data) {
    // hide loader
    document.getElementById('loader').classList.add('fade');

    rows = Array.isArray(data) ? data : [];
    byGenre = new Map();
    for (const r of rows){
      const g = (r?.genre || '').toString().trim();
      const t = (r?.text  || '').toString().trim();
      if (!g || !t) continue;
      if (!byGenre.has(g)) byGenre.set(g, []);
      byGenre.get(g).push({ text: t, url: r?.url || null });
    }
    renderGenres();
    wireSearch();
  }

  // --- Error handler that also hides loader so you can see the UI frame ---
  function showErr(msg){
    document.getElementById('loader').classList.add('fade');
    panelEl.style.display = 'block';
    titleEl.textContent = 'Error';
    listEl.innerHTML = '';
    footerEl.textContent = '';
    errEl.textContent = msg;
    console.error(msg);
  }

  // --- JSONP fallback (avoids CORS entirely) ---
  function loadViaJSONP() {
    const cb = 'initFromAPI_' + Math.random().toString(36).slice(2);
    window[cb] = function(payload){
      try {
        finishInit(payload && payload.data);
      } catch (e) {
        showErr('JSONP parse error: ' + (e?.message || e));
      } finally {
        // cleanup
        delete window[cb];
        if (script && script.parentNode) script.parentNode.removeChild(script);
      }
    };
    const url = API + (API.includes('?') ? '&' : '?') + 'callback=' + encodeURIComponent(cb);
    const script = document.createElement('script');
    script.src = url;
    script.onerror = () => showErr('JSONP load failed. Check your /exec URL.');
    document.head.appendChild(script);
  }

  // --- Preferred: fetch JSON; if it fails (CORS, etc.), fall back to JSONP ---
  window.addEventListener('load', () => {
    // Safety: fade loader after 8s so you’re never “stuck” unseen
    setTimeout(() => {
      const loader = document.getElementById('loader');
      if (loader && !loader.classList.contains('fade')) {
        showErr('Loading is taking longer than expected. Please check the API URL or try again.');
      }
    }, 8000);

    fetch(API, { mode: 'cors' })
      .then(r => {
        // Some CORS failures look like "TypeError: Failed to fetch" and never reach here.
        if (!r.ok) throw new Error('Network error: ' + r.status);
        // If the server didn't set CORS headers, the browser may still block .json().
        return r.json();
      })
      .then(({ data }) => finishInit(data))
      .catch(err => {
        console.warn('Fetch failed, falling back to JSONP:', err);
        loadViaJSONP();
      });
  });

  // ===== keep your existing functions below (renderGenres, selectGenre, renderList, wireSearch, applyFilter, debounce) =====
  function renderGenres(){
    genresEl.innerHTML = '';
    const genres = Array.from(byGenre.keys()).sort((a,b)=>a.localeCompare(b));
    if (!genres.length){
      genresEl.innerHTML = `<div class="empty">No genres found in Column C (rows 7–100).</div>`;
      return;
    }
    genres.forEach(g => {
      const btn = document.createElement('button');
      btn.className = 'genre-btn';
      btn.textContent = g;
      btn.onclick = () => selectGenre(g, btn);
      genresEl.appendChild(btn);
    });
  }

  function selectGenre(genre, btn){
    activeGenre = genre;
    document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    qEl.disabled = clearEl.disabled = searchBtn.disabled = false;
    currentItems = (byGenre.get(genre) || []).slice();
    titleEl.textContent = genre;
    panelEl.style.display = 'block';
    qEl.value = '';
    renderList(currentItems);
  }

  function renderList(items){
    errEl.textContent = '';
    listEl.innerHTML = '';
    if (!items.length){
      listEl.innerHTML = `<li class="empty">No entries for this genre.</li>`;
      footerEl.textContent = '0 items';
      return;
    }
    for (const it of items){
      const li = document.createElement('li');
      if (it.url){
        const a = document.createElement('a');
        a.href = it.url; a.target = '_blank'; a.rel = 'noopener noreferrer';
        a.textContent = it.text;
        li.appendChild(a);
      } else {
        li.textContent = it.text;
      }
      listEl.appendChild(li);
    }
    footerEl.textContent = `${items.length} item${items.length===1?'':'s'}`;
  }

  function wireSearch(){
    const debounced = debounce(applyFilter, 150);
    qEl.addEventListener('input', debounced);
    searchBtn.addEventListener('click', e => { e.preventDefault(); applyFilter(); });
    clearEl.addEventListener('click', e => { e.preventDefault(); qEl.value=''; applyFilter(); });
    qEl.addEventListener('keydown', e => { if (e.key === 'Escape'){ qEl.value=''; applyFilter(); } });
  }

  function applyFilter(){
    if (!activeGenre){ return; }
    const q = qEl.value.trim().toLowerCase();
    if (!q){ renderList(currentItems); return; }
    const filtered = currentItems.filter(it => (it.text || '').toLowerCase().includes(q));
    renderList(filtered);
  }

  function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
</script>
  </body>
</html>
